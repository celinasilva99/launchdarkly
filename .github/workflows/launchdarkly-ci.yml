name: Deploy and Toggle Feature Flag

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      LD_ACCESS_TOKEN: ${{ secrets.LAUNCHDARKLY_API_KEY }}
      LD_PROJECT_KEY: ${{ secrets.PROJECT_KEY }}
      LD_FEATURE_FLAG_KEY: ${{ secrets.FEATURE_FLAG_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Grant execution permission for deploy.sh
        run: chmod +x deploy.sh

      - name: Debug Environment Variables
        run: |
          echo "LD_ACCESS_TOKEN is set"
          echo "LD_ACCESS_TOKEN starts with: $(echo $LD_ACCESS_TOKEN | cut -c1-5)****"

      - name: Check if Secrets are Empty
        run: |
          if [[ -z "$LD_ACCESS_TOKEN" ]]; then
            echo "LD_ACCESS_TOKEN is EMPTY!"
            exit 1
          else
            echo "LD_ACCESS_TOKEN is set."
          fi

      - name: Deploy the application
        run: ./deploy.sh

      - name: Enable Feature in LaunchDarkly
        run: |
          curl -v -X PATCH "https://app.launchdarkly.com/api/v2/flags/$LD_PROJECT_KEY/$LD_FEATURE_FLAG_KEY" \
          -H "Authorization: Bearer $LD_ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"on": true}'
