name: Deploy and Toggle Feature Flag

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Grant execution permission for deploy.sh
        run: chmod +x deploy.sh

      - name: Set up environment variables
        run: |
          echo "LD_PROJECT_KEY=${{ secrets.PROJECT_KEY }}" >> $GITHUB_ENV
          echo "LD_FEATURE_FLAG_KEY=${{ secrets.FEATURE_FLAG_KEY }}" >> $GITHUB_ENV
          echo "LD_ACCESS_TOKEN=${{ secrets.LAUNCHDARKLY_API_KEY }}" >> $GITHUB_ENV

      - name: Test LaunchDarkly API Key
        run: |
          echo "LAUNCHDARKLY_API_KEY is set"
          echo "Token length: ${#secrets.LAUNCHDARKLY_API_KEY}"  # This will print the length of the secret



      - name: Deploy the application
        run: ./deploy.sh
        env:
          LD_ACCESS_TOKEN: ${{ secrets.LAUNCHDARKLY_API_KEY }}
          LD_PROJECT_KEY: ${{ secrets.PROJECT_KEY }}
          LD_FEATURE_FLAG_KEY: ${{ secrets.FEATURE_FLAG_KEY }}

      - name: Enable Feature in LaunchDarkly
        run: |
          curl -X PATCH "https://app.launchdarkly.com/api/v2/flags/default/promo-banner" \
          -H "Authorization: Bearer api-44d8a3d3-7a63-4423-b1f2-64ffed2a5fcf" \
          -H "Content-Type: application/json" \
          -d '{"on": true}'

